<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>4me Teknisyen Paneli</title>
<style>
:root{--bg:#f5f7fb;--fg:#0f2740;--line:#e5e7eb;--muted:#6b7280;--card:#fff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif;color:#0b1220}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);
  padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
header h1{margin:0;font-size:16px;color:#0f2740;font-weight:700}
.btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:600;font-size:14px;cursor:pointer}
.btn.ghost{background:#fff;border:1px solid var(--line)}
.wrap{padding:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:10px 6px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
.row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap}
.status{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid var(--line)}
.s-assigned{background:#fff7ed;color:#b45309;border-color:#fcd34d}
.s-accepted{background:#f0fdf4;color:#15803d;border-color:#86efac}
.s-in_progress{background:#eff6ff;color:#1d4ed8;border-color:#93c5fd}
.meta{font-size:12px;color:#6b7280}
.title{font-size:15px;font-weight:700;margin:6px 0;color:#0b1220}
.sub{font-size:13px;color:#374151;white-space:pre-wrap}
.empty{padding:20px;text-align:center;color:#6b7280}
.toast{position:fixed;left:50%;transform:translateX(-50%) translateY(10px);bottom:14px;background:#0a7c2f;color:#fff;
  padding:10px 14px;border-radius:12px;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,.18);opacity:0;transition:.25s}
.toast.show{opacity:1;transform:translateX(-50%)}
@keyframes blink{0%,50%,100%{background:#fff7ed}25%,75%{background:#fca5a5}}
.blink{animation:blink 1.5s infinite}
</style>
</head>
<body>
<header>
  <h1>4me Teknisyen Paneli</h1>
  <button id="refreshBtn" class="btn ghost">Yenile</button>
</header>

<div id="list" class="wrap"><div class="empty">YÃ¼kleniyorâ€¦</div></div>
<div id="toast" class="toast"></div>

<script>
const API = "https://4me-proxy.adb-toc.workers.dev/api/requests?per_page=100";

function toast(m,ok=true){
  const t=document.getElementById("toast");
  t.textContent=m;
  t.style.background=ok?"#0a7c2f":"#9b1c1c";
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1800);
}

function fmtDate(s){
  try{return new Date(s).toLocaleString("tr-TR");}
  catch{return s||"";}
}

function statusBadge(s){
  const map={assigned:["AtandÄ±","s-assigned"],accepted:["Kabul Edildi","s-accepted"],in_progress:["Devam Ediyor","s-in_progress"]};
  const [l,c]=map[s]||[s,""];
  return `<span class="status ${c}">${l}</span>`;
}

function isAllowedJob(req){
  const txt = (req.subject||"").toLowerCase();
  const allow = ["arÄ±za","talep","istek","aydÄ±nlatma"];
  const block = ["bakÄ±m","planlÄ±","koruyucu","periyodik"];
  if(block.some(w=>txt.includes(w))) return false;
  return allow.some(w=>txt.includes(w));
}

async function fetchData(){
  try{
    const r = await fetch(API);
    if(!r.ok) throw new Error("HTTP "+r.status);
    const d = await r.json();
    renderList(Array.isArray(d)?d:(d.requests||[]));
  }catch(e){
    document.getElementById("list").innerHTML=`<div class="empty">YÃ¼klenemedi<br>${e.message}</div>`;
    console.error(e);
  }
}

function renderList(data){
  const items=data.filter(isAllowedJob);
  const list=document.getElementById("list");
  if(!items.length){list.innerHTML='<div class="empty">KayÄ±t yok.</div>';return;}
  const frag=document.createDocumentFragment();
  for(const r of items){
    const assignee=r.assigned_to?.name||r.assigned_to?.email||"BelirtilmemiÅŸ";
    const card=document.createElement("div");
    card.className="card";
    if(r.status==="assigned") card.classList.add("blink");
    card.innerHTML=`
      <div class="row1"><div>${statusBadge(r.status)} <span class="meta">${fmtDate(r.created_at)}</span></div><div class="meta">#${r.id}</div></div>
      <div class="title">${r.team?.name||""}</div>
      <div class="sub">${r.subject||""}\nðŸ‘¤ ${assignee}</div>`;
    frag.appendChild(card);
  }
  list.replaceChildren(frag);
}

document.getElementById("refreshBtn").onclick=fetchData;
fetchData();
setInterval(fetchData,60000);
</script>
</body>
</html>
