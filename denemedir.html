<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>4me Teknisyen Paneli</title>
  <style>
    :root{--bg:#f5f7fb;--fg:#0f2740;--line:#e5e7eb;--muted:#6b7280;--card:#fff}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif;color:#0b1220}
    header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);
      padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
    header h1{margin:0;font-size:16px;color:#0f2740;font-weight:700}
    .who{font-size:12px;color:#374151}
    .btn{appearance:none;border:0;border-radius:12px;padding:10px 12px;font-weight:600;font-size:14px;cursor:pointer}
    .btn.ghost{background:#fff;border:1px solid var(--line)}
    .btn.success{background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff}
    .btn.blue{background:linear-gradient(135deg,#2563eb,#3b82f6);color:#fff}
    .btn.red{background:linear-gradient(135deg,#dc2626,#ef4444);color:#fff}
    .toolbar{display:grid;grid-template-columns:1fr auto;gap:10px;padding:10px 14px;background:#fff;border-bottom:1px solid var(--line)}
    .input,select{width:100%;padding:12px 14px;border:1px solid var(--line);border-radius:10px;background:#fff;font-size:15px}
    .wrap{padding:10px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:10px 6px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;gap:8px;flex-wrap:wrap}
    .status{font-size:12px;font-weight:800;padding:6px 10px;border-radius:999px;border:1px solid var(--line)}
    .s-assigned{background:#fff7ed;color:#b45309;border-color:#fcd34d}
    .s-accepted{background:#f0fdf4;color:#15803d;border-color:#86efac}
    .s-in_progress{background:#eff6ff;color:#1d4ed8;border-color:#93c5fd}
    .meta{font-size:12px;color:#6b7280}
    .title{font-size:15px;font-weight:700;margin:6px 0;color:#0b1220}
    .sub{font-size:13px;color:#374151;white-space:pre-wrap}
    .actions{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .empty{padding:20px;text-align:center;color:#6b7280}
    .toast{position:fixed;left:50%;transform:translateX(-50%) translateY(10px);bottom:14px;background:#0a7c2f;color:#fff;
      padding:10px 14px;border-radius:12px;font-weight:700;box-shadow:0 8px 30px rgba(0,0,0,.18);opacity:0;transition:.25s}
    .toast.show{opacity:1;transform:translateX(-50%)}
    @keyframes blink {
      0%,50%,100%{background-color:#fff7ed}
      25%,75%{background-color:#f87171}
    }
    .blink{animation:blink 1.5s infinite}
    /* login modal */
    #loginModal{position:fixed;top:0;left:0;width:100%;height:100%;
      backdrop-filter:blur(10px);background:rgba(0,0,0,.45);
      display:flex;align-items:center;justify-content:center;z-index:999;visibility:hidden;opacity:0;transition:.3s}
    #loginModal.show{visibility:visible;opacity:1}
    .modal-box{background:#fff;padding:20px;border-radius:14px;max-width:90%;width:360px;text-align:left}
  </style>
</head>
<body>
<header>
  <h1>4me Teknisyen Paneli</h1>
  <div class="who" id="whoBox"></div>
  <div style="display:flex;gap:8px">
    <button id="refreshBtn" class="btn ghost">Yenile</button>
    <button id="logoutBtn" class="btn red">√áƒ±kƒ±≈ü</button>
  </div>
</header>

<div class="toolbar">
  <input id="searchInput" class="input" type="search" placeholder="Konu i√ßinde ara..." />
  <select id="statusFilter">
    <option value="" selected>Hepsi</option>
    <option value="assigned">Atandƒ±</option>
    <option value="accepted">Kabul Edildi</option>
    <option value="in_progress">Devam Ediyor</option>
  </select>
</div>

<div id="list" class="wrap"><div class="empty">Y√ºkleniyor‚Ä¶</div></div>
<div id="toast" class="toast"></div>

<!-- login modal -->
<div id="loginModal" class="modal">
  <div class="modal-box">
    <h2>Giri≈ü</h2>
    <p>Ad Soyad gir, ekibini se√ß.</p>
    <input id="nameInput" class="input" placeholder="Ad Soyad" style="margin-bottom:10px">
    <select id="teamSelect" class="input"><option value="">Ekip se√ßiniz‚Ä¶</option></select>
    <div style="text-align:right;margin-top:12px">
      <button id="loginBtn" class="btn blue">Devam</button>
    </div>
  </div>
</div>

<script>
const API = "https://4me-proxy.adb-toc.workers.dev/api/requests?per_page=100";
let DATA=[],initialLoaded=false,isRefreshing=false;
const LS_NAME="tech_name",LS_TEAM="tech_team";

function toast(m,ok=true){
  const t=document.getElementById("toast");
  t.textContent=m;t.style.background=ok?"#0a7c2f":"#9b1c1c";
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),1600);
}

function fmtDate(s){try{return new Date(s).toLocaleString("tr-TR");}catch{return s||"";}}

function statusBadge(s){
  const map={assigned:["Atandƒ±","s-assigned"],accepted:["Kabul Edildi","s-accepted"],in_progress:["Devam Ediyor","s-in_progress"]};
  const [l,c]=map[s]||[s,""];return `<span class="status ${c}">${l}</span>`;
}

function getUser(){return {name:localStorage.getItem(LS_NAME)||"",team:localStorage.getItem(LS_TEAM)||""};}
function setUser(n,t){localStorage.setItem(LS_NAME,n);localStorage.setItem(LS_TEAM,t);paintWho();}
function clearUser(){localStorage.removeItem(LS_NAME);localStorage.removeItem(LS_TEAM);paintWho();}
function show(el,on=true){el.classList.toggle("show",on);}
function paintWho(){
  const b=document.getElementById("whoBox");
  const u=getUser();
  b.textContent=u.name&&u.team?`${u.name} ‚Ä¢ ${u.team}`:"";
}

async function fetchRequests(){
  const r=await fetch(API);
  if(!r.ok)throw new Error("HTTP "+r.status);
  let d=await r.json();
  if(Array.isArray(d.requests)) d=d.requests;
  return d;
}

async function safeRefresh(){
  if(isRefreshing)return;
  isRefreshing=true;
  try{
    const fresh=await fetchRequests();
    if(Array.isArray(fresh)){
      DATA=fresh;
      if(!initialLoaded){fillTeams();initialLoaded=true;}
      renderList();
    }
  }catch(e){toast("Yenileme hatasƒ±",false);}
  finally{isRefreshing=false;}
}

function fillTeams(){
  const s=document.getElementById("teamSelect");
  const teams=[...new Set(DATA.map(r=>r.team?.name).filter(Boolean))].sort();
  s.innerHTML='<option value="">Ekip se√ßiniz‚Ä¶</option>'+teams.map(t=>`<option value="${t}">${t}</option>`).join("");
}

function renderList(){
  const q=document.getElementById("searchInput").value.toLowerCase();
  const f=document.getElementById("statusFilter").value;
  const list=document.getElementById("list");
  const u=getUser();
  let items=DATA.filter(r=>(!u.team||(r.team?.name||"")===u.team));
  if(q)items=items.filter(r=>(r.subject||"").toLowerCase().includes(q));
  if(f)items=items.filter(r=>r.status===f);
  const order={assigned:1,accepted:2,in_progress:3};
  items.sort((a,b)=>(order[a.status]||9)-(order[b.status]||9));
  if(!items.length){list.innerHTML='<div class="empty">Kayƒ±t yok.</div>';return;}
  const frag=document.createDocumentFragment();
  for(const r of items){
    const assignee=r.assigned_to?.name||r.assigned_to?.email||"Belirtilmemi≈ü";
    const note=(r.custom_fields||[]).find(x=>x.id==="work_desc")?.value||"";
    const card=document.createElement("div");card.className="card";
    if(r.status==="assigned")card.classList.add("blink");
    card.innerHTML=`
      <div class="row1"><div>${statusBadge(r.status)} <span class="meta">${fmtDate(r.created_at)}</span></div><div class="meta">#${r.id}</div></div>
      <div class="title">${r.team?.name||""}<span class="tag">${r.service_instance?.name||""}</span></div>
      <div class="sub">${r.subject||""}\nüë§ Atanan Ki≈üi: ${assignee}\n${note?`\nüßæ ${note}`:""}\nüë∑‚Äç‚ôÇÔ∏è ${u.name}</div>
    `;
    frag.appendChild(card);
  }
  list.replaceChildren(frag);
}

document.getElementById("refreshBtn").onclick=safeRefresh;
document.getElementById("logoutBtn").onclick=()=>{clearUser();show(document.getElementById("loginModal"),true);};
document.getElementById("searchInput").oninput=renderList;
document.getElementById("statusFilter").onchange=renderList;
document.getElementById("loginBtn").onclick=()=>{
  const n=document.getElementById("nameInput").value.trim();
  const t=document.getElementById("teamSelect").value;
  if(!n)return toast("Ad soyad gir",false);
  if(!t)return toast("Ekip se√ß",false);
  setUser(n,t);
  show(document.getElementById("loginModal"),false);
  renderList();
  safeRefresh();
};

paintWho();
(async()=>{await safeRefresh();const u=getUser();show(document.getElementById("loginModal"),!(u.name&&u.team));})();
</script>
</body>
</html>
