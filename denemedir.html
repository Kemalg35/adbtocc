<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>4me Teknisyen Paneli</title>
<style>
:root{--bg:#f5f7fb;--fg:#0f2740;--line:#e5e7eb;--muted:#6b7280;--card:#fff}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:system-ui,"Segoe UI",Roboto,Arial,sans-serif;color:#0b1220}
header{position:sticky;top:0;z-index:10;background:#fff;border-bottom:1px solid var(--line);
  padding:10px 14px;display:flex;justify-content:space-between;align-items:center}
header h1{margin:0;font-size:16px;color:#0f2740;font-weight:700}
.btn{appearance:none;border:0;border-radius:12px;padding:8px 12px;font-weight:600;font-size:14px;cursor:pointer}
.btn.success{background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff}
.btn.blue{background:linear-gradient(135deg,#2563eb,#3b82f6);color:#fff}
.btn.red{background:linear-gradient(135deg,#dc2626,#ef4444);color:#fff}
.wrap{padding:10px}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;margin:10px 6px;
  box-shadow:0 2px 10px rgba(0,0,0,.04);transition:background .3s ease}
.row1{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.status{font-size:12px;font-weight:800;padding:4px 8px;border-radius:999px;border:1px solid var(--line)}
.s-assigned{background:#fff7ed;color:#b45309;border-color:#fcd34d}
.s-accepted{background:#f0fdf4;color:#15803d;border-color:#86efac}
.s-in_progress{background:#eff6ff;color:#1d4ed8;border-color:#93c5fd}
.meta{font-size:12px;color:#6b7280}
.title{font-size:15px;font-weight:700;margin:4px 0;color:#0b1220}
.sub{font-size:13px;color:#374151;white-space:pre-wrap}
@keyframes blink{0%,50%,100%{background-color:#fff7ed}25%,75%{background-color:#fca5a5}}
.blink{animation:blink 1.5s infinite}
.toast{position:fixed;left:50%;bottom:14px;transform:translateX(-50%);
background:#0a7c2f;color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;
box-shadow:0 8px 30px rgba(0,0,0,.18);opacity:0;transition:.3s}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
</style>
</head>
<body>
<header>
  <h1>4me Teknisyen Paneli</h1>
  <div>
    <button id="refreshBtn" class="btn blue">Yenile</button>
  </div>
</header>

<div id="list" class="wrap"><div class="meta">Yükleniyor…</div></div>
<div id="toast" class="toast"></div>

<script>
const API_BASE = "https://4me-proxy.adb-toc.workers.dev/api";
const headers = {"Accept":"application/json","Content-Type":"application/json"};
let DATA = [];

function toast(m, ok=true){
  const t=document.getElementById("toast");
  t.textContent=m;
  t.style.background=ok?"#0a7c2f":"#9b1c1c";
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"),2000);
}

function fmtDate(s){try{return new Date(s).toLocaleString("tr-TR");}catch{return s;}}
function statusBadge(s){
  const map={assigned:["Atandı","s-assigned"],accepted:["Kabul Edildi","s-accepted"],in_progress:["Devam Ediyor","s-in_progress"]};
  const [l,c]=map[s]||[s,""];
  return `<span class="status ${c}">${l}</span>`;
}

async function fetchRequests(){
  const r=await fetch(`${API_BASE}/requests?per_page=100`,{headers});
  if(!r.ok) throw new Error("HTTP "+r.status);
  return await r.json();
}

async function patchRequest(id, body){
  const r=await fetch(`${API_BASE}/requests/${id}`,{
    method:"PATCH",headers,body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error("PATCH "+r.status);
  return await r.json();
}

function isAllowedJob(r){
  const t=(r.subject||"").toLowerCase();
  const neg=["bakım","periyodik","preventive","planlı"];
  for(const n of neg) if(t.includes(n)) return false;
  return t.includes("arıza")||t.includes("talep")||t.includes("istek")||t.includes("aydınlatma");
}

async function load(){
  const list=document.getElementById("list");
  list.innerHTML="<div class='meta'>Yükleniyor...</div>";
  try{
    const raw=await fetchRequests();
    DATA=Array.isArray(raw)?raw.filter(isAllowedJob):[];
    if(!DATA.length){list.innerHTML="<div class='meta'>Kayıt bulunamadı.</div>";return;}
    const frag=document.createDocumentFragment();
    for(const r of DATA){
      const card=document.createElement("div");
      card.className="card";
      if(r.status==="assigned") card.classList.add("blink");
      card.innerHTML=`
        <div class="row1">
          <div>${statusBadge(r.status)} <span class="meta">${fmtDate(r.created_at)}</span></div>
          <div class="meta">#${r.id}</div>
        </div>
        <div class="title">${r.team?.name||""}</div>
        <div class="sub">${r.subject||""}</div>
        <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn success" onclick="accept(${r.id})">Kabul Et</button>
          <button class="btn blue" onclick="addNote(${r.id})">Açıklama Ekle</button>
        </div>`;
      frag.appendChild(card);
    }
    list.replaceChildren(frag);
  }catch(e){
    list.innerHTML="<div class='meta'>Yenileme hatası: "+e.message+"</div>";
  }
}

async function accept(id){
  try{
    await patchRequest(id,{status:"accepted"});
    toast("Kayıt kabul edildi");
    load();
  }catch(e){toast("Hata:"+e.message,false);}
}

async function addNote(id){
  const note=prompt("Açıklama gir:");
  if(!note)return;
  try{
    await patchRequest(id,{custom_fields:[{id:"work_desc",value:note}]});
    toast("Açıklama kaydedildi");
    load();
  }catch(e){toast("Hata:"+e.message,false);}
}

document.getElementById("refreshBtn").onclick=load;
load();
setInterval(load,60000); // her 1 dakikada bir yenile
</script>
</body>
</html>
